# v2sort

`v2sort` — консольная утилита на C++ для проверки и сортировки списка прокси (VLESS/VMess/Trojan/SS и др. форматы, которые распознаются регулярным выражением), с запуском `xray`, измерением сетевых метрик через `libcurl` и выводом краткого отчёта по каждому прокси.

## Что делает проект

- читает список прокси из файла (`-l`);
- извлекает прокси по встроенному или пользовательскому regex (`-R`);
- генерирует временный конфиг для `xray`;
- поднимает локальные SOCKS5-inbounds на последовательных портах;
- проверяет доступность/скорость через набор URL из конфигурации `v2sort.toml`;
- запрашивает geo/IP-данные через `https://ipinfo.io/json`;
- применяет фильтры по протоколам, странам и IP;
- печатает итоговые метрики в stdout.

## Платформа и ограничения

> Поддерживается **только Linux с glibc**.

Причины:

- используется `getopt_long`, `unistd.h`, `pwd.h`, `ftruncate`, `/dev/*`-пути;
- сборка и рантайм ориентированы на GNU toolchain (`g++`, `libstdc++`, `__gnu_cxx::stdio_filebuf`);
- в Makefile и коде нет поддержки macOS/Windows/musl как целевых платформ.

Если нужен Alpine/musl или другие ОС, потребуется отдельная адаптация и тестирование.

## Зависимости

### Runtime

- `xray` (по умолчанию ожидается в `/usr/local/bin/xray`, можно переопределить в конфиге);
- доступ в интернет для проверок URL и запроса `ipinfo.io`.

### Build-time

- `g++` с поддержкой C++20;
- `make`;
- Boost (используются компоненты: `json`, `url`, `locale`, `system`, `filesystem`, `thread`, `regex`, `date_time`, `log`, `log_setup`, `process`);
- `libcurl`;
- `pthread`;
- заголовки `toml++`.

### Пример установки зависимостей (Debian/Ubuntu)

```bash
sudo apt update
sudo apt install -y \
  build-essential make pkg-config \
  libboost-all-dev \
  libcurl4-openssl-dev
```

`toml++` может понадобиться установить отдельно (в зависимости от дистрибутива/версии пакетов), либо добавить include-путь вручную.

## Сборка

```bash
make
```

Отладочная сборка:

```bash
make debug
```

Очистка:

```bash
make clean
```

## Конфигурация

По умолчанию конфиг читается из:

- `$HOME/.v2sort` (приоритетно);
- fallback-путь в коде: `/etc/v2sort/config`.

Можно явно указать конфиг:

```bash
./v2sort -c /path/to/config.toml -l proxies.txt
```

В репозитории есть пример конфигурации: `v2sort.toml`.

## Быстрый старт

1. Подготовьте файл с прокси, например `proxies.txt`.
2. Скопируйте `v2sort.toml` в `~/.v2sort` и при необходимости отредактируйте.
3. Убедитесь, что `xray` доступен (или укажите путь в конфиге).
4. Запустите:

```bash
./v2sort -l proxies.txt -j 4 -T 5
```

## Аргументы CLI

- `-c, --config FILE` — путь к конфигу;
- `-l, --list FILE` — файл со списком прокси (**обязательный**);
- `-j, --jobs NUM` — число потоков;
- `-p, --port NUM` — начальный порт для локальных SOCKS5-inbound;
- `-v, --verbose` — подробный лог;
- `-r, --random` — тестировать один случайный URL из `settings.urls`;
- `-w, --wait MS` — ожидание старта `xray` в миллисекундах;
- `-T, --timeout` — timeout сетевых операций (секунды);
- `-R, --regex` — пользовательское regex-правило извлечения прокси;
- `-4, --ipv4_only` — использовать только IPv4;
- `-6, --ipv6_only` — использовать только IPv6.

`-4` и `-6` взаимоисключающие.

## Пример запуска

```bash
./v2sort \
  -l proxies.txt \
  -c ./v2sort.toml \
  -j 8 \
  -p 10808 \
  -T 5 \
  -w 3500
```

## Вывод

Для каждого прокси выводятся:

- исходный URL прокси;
- IP/страна (по `ipinfo.io`);
- `HTTP code`;
- времена: `t_dns`, `t_connect`, `t_tls`, `t_ttfb`, `t_total`;
- скорость загрузки и объём.

## Примечания

- Проект использует агрессивные флаги оптимизации (`-O3`, `-march=native`, LTO), поэтому бинарник может быть менее переносим между разными CPU.
- Для стабильной работы проверьте права/пути логов `xray` в конфиге.
